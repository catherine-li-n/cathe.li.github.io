<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"><meta name="description" content="Go表单&amp;&amp;文件 [ catherien's blog ] "><meta name="theme-color" content="#ebc65a"><title>Go表单&amp;&amp;文件 [ catherien's blog ] </title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><script src="https://cdn.bootcss.com/highlight.js/9.6.0/highlight.min.js" defer></script><script src="/js/paper.js" defer></script><script src="https://www.googletagmanager.com/gtag/js?id=xx-xxxxxxx-xx" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'xx-xxxxxxx-xx');</script><link rel="stylesheet" href="/css/tocbot.css"><script src="/js/tocbot.js" defer></script><script>window.addEventListener('DOMContentLoaded', () => {
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '.toc__content',
    // Where to grab the headings to build the table of contents.
    contentSelector: '.article__content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    // For headings inside relative or absolute positioned containers within content.
    hasInnerContainers: true,
    orderedList: false,
    collapseDepth: 2,
  });
})</script><link rel="preload" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/github.min.css"><link rel="preload" href="https://fonts.googleapis.com/css?family=Abril+Fatface&amp;display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface&amp;display=swap"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="mask-border"></div><div class="head"><div class="head__inner"><h1><a href="/">catherien's blog</a></h1><p></p></div></div><div class="paper-container"><div class="main"><div class="location-bar"><div class="line-1"><div class="horizontal-line" style="height: 3px"></div></div><div class="line-2"><div class="horizontal-line" style="height: 1px"></div></div><p class="text">Go表单&amp;&amp;文件</p><div class="switch-button"><input class="container_toggle" type="checkbox" id="switch" name="mode"><label for="switch">Toggle</label></div><div class="line-3"><div class="horizontal-line" style="height: 1px"></div></div></div><div class="main__2-col"><article class="post-view__article"><div class="article__infomation"><div class="posts-item"><h2 class="posts-item__title"><a href="">Go表单&amp;&amp;文件</a></h2><span class="post__date">2020-09-25</span><a href="/tags/go/"><span class="post__tags">#go</span></a><a href="/tags/go%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/"><span class="post__tags">#go基础学习</span></a></div></div><div class="article__content"><p>Go 表单</p>
<h1 id="从login开始"><a href="#从login开始" class="headerlink" title="从login开始"></a>从login开始</h1><p>首先先新建一个常见的<code>login.html</code></p>
<p>然后在之前写的简易web服务器中插入一条handleFunc<br><code>http.HandleFunc(&quot;/login&quot;, login)</code><br>内容如下：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">login</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>	fmt.Println(“method”, r.Method)<br>	<span class="hljs-keyword">if</span> r.Method == “GET” &#123;<br>		t, _ := template.ParseFiles(“login.html”)<br>		log.Println(t.Execute(w, <span class="hljs-literal">nil</span>))<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		err := r.ParseForm()<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(err)<br>		&#125;<br>		fmt.Println(“username”, r.Form[“username”]) <span class="hljs-comment">// 必须显式的调用r.ParseForm()后才能对表单进行操作</span><br>		fmt.Println(“password”, r.Form[“password”])<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="预防跨站脚本"><a href="#预防跨站脚本" class="headerlink" title="预防跨站脚本"></a>预防跨站脚本</h2><p>动态站点会受到一种名为“CrossSite Scripting”的威胁，攻击者在漏洞程序中插入JavaScript、VBScript、 ActiveX或Flash以盗取用户信息、植入广告等<br>对XSS的防护应从输入和输出都进行恰当的处理。<br>对于go来说，go的html/template 里面带有几个函数可以帮你转义</p>
<ul>
<li><code>func HTMLEscape(w io.Writer, b [] byte) // 把b转义之后写到w</code></li>
<li><code>func HTMLEscapeString (s tring) string // 转义s之后返回结果字符串</code></li>
<li><code>dunc HTMLEScaper(args ..interface&#123;&#125;) string //支持多个参数一起转义 结果返回字符串</code></li>
</ul>
<h1 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h1><p>常用的表单验证已经很熟悉了</p>
<h2 id="正则类"><a href="#正则类" class="headerlink" title="正则类"></a>正则类</h2><h3 id="中文"><a href="#中文" class="headerlink" title="中文"></a>中文</h3><figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> m, _ := regexp.MatchString(“^\\p&#123;Han&#125;+$”, r.Form.Get(“realname”); !m &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="英文"><a href="#英文" class="headerlink" title="英文"></a>英文</h3><figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go">If m, _ := regexp.MatchString(‘^([a-zA-Z]+$’, r.Form.Get(“engname)); !m &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="日期和时间"><a href="#日期和时间" class="headerlink" title="日期和时间"></a>日期和时间</h2><p>用户输入的时间是否符合逻辑也要进行验证</p>
<h2 id="防止表单多次提交"><a href="#防止表单多次提交" class="headerlink" title="防止表单多次提交"></a>防止表单多次提交</h2><p>在表中添加<code>&lt;input type=“hidden” name=“token” value=“&#123;&#123;.&#125;&#125;”&gt;</code><br>我认为他类似于Django 模版中的 <code>&#123;% csrf_token %&#125;</code></p>
<h2 id="File-Upload"><a href="#File-Upload" class="headerlink" title="File Upload"></a>File Upload</h2><ol>
<li>在表单中添加enctype=“multipart/form-data”</li>
<li>服务器端调用<code>r.ParseMultipartForm</code>，把上传的文件存储在内存和临时文件中</li>
<li>使用<code>r.FormFile</code>获取文件句柄，然后对文件进行存储等处理</li>
</ol>
<p>模仿一个发送端+客户端的文件上传功能</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">upload</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;<br>	fmt.Println(“method:”, r.Method)<br>	<span class="hljs-keyword">if</span> r.Method == “GET” &#123;<br>		crutime := time.Now().Unix()<br>		h := md5.New()<br>		io.WriteString(h, strconv.FormatInt(crutime, <span class="hljs-number">10</span>))<br>		token := fmt.Sprintf(“%x”, h.Sum(<span class="hljs-literal">nil</span>))<br><br>		t, _ := template.ParseFiles(“upload.html”)<br>		t.Execute(w, token)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		r.ParseMultipartForm(<span class="hljs-number">32</span> &lt;&lt; <span class="hljs-number">20</span>) <span class="hljs-comment">// Step2</span><br>		file, handler, err := r.FormFile(“uploadfile”) <span class="hljs-comment">// Step3</span><br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		<span class="hljs-keyword">defer</span> file.Close()<br>		fmt.Fprint(w, “%v”, handler.Header)<br>		f, err := os.OpenFile(“./test/“ + handler.Filename, os.*O_WRONLY*|os.*O_CREATE*, <span class="hljs-number">0666</span>)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			fmt.Println(err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		<span class="hljs-keyword">defer</span> f.Close()<br>		io.Copy(f, file)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>客户端通过multipart.Write把文件的文本流写入一个缓存中，然后调用http的Post方法把缓存传到服务器。<br>postFile</p>
<figure class="highlight go"><table><tr><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 模仿客户端发送文件</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">postFile</span><span class="hljs-params">(filename <span class="hljs-keyword">string</span>, targetUrl <span class="hljs-keyword">string</span> )</span> <span class="hljs-title">error</span></span> &#123;<br>	bodyBuf := &amp;bytes.Buffer&#123;&#125;<br>	bodyWriter := multipart.NewWriter(bodyBuf)<br><br>	fileWriter, err := bodyWriter.CreateFormFile(“uploadfile”, filename)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(“error writing to buffer”)<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br><br>	fh, err := os.Open(filename)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(“eroor opening file”)<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	<span class="hljs-keyword">defer</span> fh.Close()<br><br>	_, err = io.Copy(fileWriter, fh)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br><br>	contentType := bodyWriter.FormDataContentType()<br>	bodyWriter.Close()<br><br>	resp, err := http.Post(targetUrl, contentType, bodyBuf) <span class="hljs-comment">//send file to server</span><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	<span class="hljs-keyword">defer</span> resp.Body.Close()<br>	resp_body, err := ioutil.ReadAll(resp.Body)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	fmt.Println(resp.Status)<br>	fmt.Println(<span class="hljs-keyword">string</span>(resp_body))<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// main</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	targetUrl := <span class="hljs-string">&quot;http://localhost:9090/upload&quot;</span><br>	filename := <span class="hljs-string">&quot;./input.txt&quot;</span><br>	postFile(filename, targetUrl)<br>&#125;<br></code></pre></td></tr></table></figure>



</div></article><div class="post-view__sidebar"><div class="sidebar"><div class="tocbot"><h2>Toc</h2><div class="toc__content"></div></div><h2>Links</h2><div class="sidebar__link"><ul><li><a target="_blank" rel="noopener" href="https://github.com/yours">Github</a></li><li><a target="_blank" rel="noopener" href="https://codepen.io/yours">Codepen</a></li><li><a target="_blank" rel="noopener" href="https://dribbble.com/yours">Dribbble</a></li><li><a target="_blank" rel="noopener" href="https://twitter.com/yours">Twitter</a></li><li><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/yours">知乎</a></li><li><a target="_blank" rel="noopener" href="https://juejin.im/user/yours">掘金</a></li><li><a href="mailto:xxx@yourmail.xxxx">Mail</a></li></ul></div><h2>Archives</h2><div class="sidebar__archives"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a></li></ul></div><h2>Categories</h2><div class="sidebar__categories"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Django/">Django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li></ul></div><h2>Tags</h2><div class="sidebar__tags"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Django/" rel="tag">Django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gin/" rel="tag">Gin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VueJs/" rel="tag">VueJs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/" rel="tag">go基础学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul></div></div></div></div><div class="horizontal-line" style="height: 1px"></div><div class="main__bottom"><div class="pre-next"><a class="pre-button" href="/2020/10/01/Gin%E6%A1%86%E6%9E%B6-%E8%B7%AF%E7%94%B1/">Gin框架-路由</a><a class="next-button" href="/2020/09/23/Go%20Web%E7%BC%96%E7%A8%8B/">Go Web编程</a></div></div></div></div><div class="footer"><span>©️2019-2020 Designed By&nbsp;<strong><a target="_blank" rel="noopener" href="https://github.com/random-yang">RandomYang</a></strong> Powered By&nbsp;</span><strong><a target="_blank" rel="noopener" href="https://hexo.io">hexo</a></strong></div><div class="darkmode-mask" id="darkmode-mask"></div><div class="sidebar__button"></div></body></html>